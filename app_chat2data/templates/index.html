<!-- templates/index.html - Data Upload Page with Auto Base URL Detection -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analysis Chat Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 600px;
            width: 90%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .upload-section, .db-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .upload-section:hover, .db-section:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .section-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: "üìä";
            margin-right: 10px;
        }

        .db-section .section-title::before {
            content: "üóÑÔ∏è";
        }

        .file-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: block;
            padding: 15px 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .data-info {
            background: #e2e3ea;
            border: 1px solid #d6d8db;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .data-info h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .divider {
            text-align: center;
            margin: 30px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            color: #666;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Data Analysis Chat Tool</h1>

        <!-- CSV Upload Section -->
        <div class="upload-section">
            <h2 class="section-title">Upload CSV File</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="file-input-container">
                    <input type="file" id="csvFile" name="file" accept=".csv" class="file-input">
                    <label for="csvFile" class="file-input-label">
                        Choose CSV File üìÅ
                    </label>
                </div>
                <button type="submit" class="btn" style="margin-top: 15px;">Upload File</button>
            </form>
            <div id="uploadMessage"></div>
        </div>

        <div class="divider">
            <span>OR</span>
        </div>

        <!-- Database Connection Section -->
        <div class="db-section">
            <h2 class="section-title">Connect to Database</h2>
            <form id="dbForm">
                <div class="form-group">
                    <label for="host">Host Address:</label>
                    <input type="text" id="host" name="host" placeholder="localhost">
                </div>
                <div class="form-group">
                    <label for="user">Username:</label>
                    <input type="text" id="user" name="user" placeholder="root">
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" placeholder="Password">
                </div>
                <div class="form-group">
                    <label for="database">Database Name:</label>
                    <input type="text" id="database" name="database" placeholder="Database name">
                </div>
                <div class="form-group">
                    <label for="table">Table Name:</label>
                    <input type="text" id="table" name="table" placeholder="Table name">
                </div>
                <button type="submit" class="btn">Connect Database</button>
            </form>
            <div id="dbMessage"></div>
        </div>
    </div>

    <script>
        // Ëá™Âä®Ê£ÄÊµãbase URL
        const BASE_URL = '{{ base_url }}';

        // File upload handling
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData();
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('uploadMessage', 'Please select a CSV file', 'error');
                return;
            }

            formData.append('file', file);

            showMessage('uploadMessage', 'Uploading...', 'success');

            fetch(`${BASE_URL}/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('uploadMessage', data.message, 'success');
                    if (data.data_info) {
                        showDataInfo('uploadMessage', data.data_info);
                    }
                    // ‰ΩøÁî®ËøîÂõûÁöÑÈáçÂÆöÂêëURLÊàñÈªòËÆ§Ë∑ØÂæÑ
                    const redirectUrl = data.redirect_url || `${BASE_URL}/chat`;
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 2000);
                } else {
                    showMessage('uploadMessage', data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('uploadMessage', 'Upload failed: ' + error.message, 'error');
            });
        });

        // Database connection handling
        document.getElementById('dbForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            showMessage('dbMessage', 'Connecting to database...', 'success');

            fetch(`${BASE_URL}/connect_db`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('dbMessage', data.message, 'success');
                    if (data.data_info) {
                        showDataInfo('dbMessage', data.data_info);
                    }
                    // ÈáçÂÆöÂêëÂà∞ËÅäÂ§©È°µÈù¢
                    setTimeout(() => {
                        window.location.href = `${BASE_URL}/chat`;
                    }, 2000);
                } else {
                    showMessage('dbMessage', data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('dbMessage', 'Connection failed: ' + error.message, 'error');
            });
        });

        // Show message
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        // Show data information
        function showDataInfo(elementId, dataInfo) {
            const element = document.getElementById(elementId);
            const infoHtml = `
                <div class="data-info">
                    <h3>Data Information</h3>
                    <p><strong>Rows:</strong> ${dataInfo.shape[0]}</p>
                    <p><strong>Columns:</strong> ${dataInfo.shape[1]}</p>
                    <p><strong>Column Names:</strong> ${dataInfo.columns.join(', ')}</p>
                    ${dataInfo.date_columns && dataInfo.date_columns.length > 0 ?
                        `<p><strong>Date Columns:</strong> ${dataInfo.date_columns.join(', ')}</p>` : ''}
                    ${dataInfo.encoding ? `<p><strong>Encoding:</strong> ${dataInfo.encoding}</p>` : ''}
                </div>
            `;
            element.innerHTML += infoHtml;
        }

        // File name display
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name;
            const label = document.querySelector('.file-input-label');
            if (fileName) {
                label.textContent = `Selected: ${fileName}`;
            }
        });
    </script>
</body>
</html>